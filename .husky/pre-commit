echo "ğŸ§¹ Running lint-staged (format + quick lint)..."
pnpm exec lint-staged || {
  echo "âŒ lint-staged failed. Fix issues before committing."
  exit 1
}

# Determine base branch for affected runs (mirror pre-push logic)
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  BASE="origin/main"
elif git rev-parse --verify main >/dev/null 2>&1; then
  BASE="main"
else
  BASE="HEAD~1"
fi

echo "ğŸ“Š Pre-commit checks against: $BASE"

# Type checking (full repo)
echo "ğŸ“ Type checking..."
pnpm exec tsc --noEmit || {
  echo "âŒ Type check failed. Fix type errors before committing."
  exit 1
}

# Lint affected projects (in addition to lint-staged for safety)
echo "ğŸ” Linting affected projects..."
pnpm nx affected -t lint --base="$BASE" --parallel=3 || {
  echo "âŒ Lint failed on affected projects."
  exit 1
}

# Test affected projects
echo "ğŸ§ª Testing affected projects..."
pnpm nx affected -t test --base="$BASE" --parallel=3 || {
  echo "âŒ Tests failed on affected projects."
  exit 1
}

# Build affected projects
echo "ğŸ—ï¸  Building affected projects..."
pnpm nx affected -t build --base="$BASE" --parallel=3 || {
  echo "âŒ Build failed on affected projects."
  exit 1
}

echo "âœ… Pre-commit checks passed!"
